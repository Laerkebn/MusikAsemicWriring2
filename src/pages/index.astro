---
import Layout from "../layouts/Layout.astro";
import "../styles.css"; 
---

<Layout>
  <!-- Tailwind CSS fra CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Lille animation til de nye bokse -->
  <style>
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>

  <!-- Titel -->
  <h1 class="text-4xl font-bold text-center mb-8 text-blue-600">
    üéµ Tone ‚Üí SVG generator
  </h1>

  <!-- Samlet boks -->
  <div class="bg-white rounded-lg shadow-md p-6 space-y-8">

    <!-- Knapper -->
    <div>
      <h2 class="text-xl font-semibold mb-4">Generer din sang vibe:</h2>
      <div class="flex flex-wrap gap-4">
        <button 
          id="startMic"
          class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded disabled:bg-gray-300 disabled:cursor-not-allowed">
          üé§ Start mikrofon
        </button>
        <button 
          id="stopMic"
          disabled
          class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded disabled:bg-gray-300 disabled:cursor-not-allowed">
          ‚èπÔ∏è Stop mikrofon
        </button>
      </div>
    </div>

    <!-- Fil upload -->
    <div>
      <label class="block text-sm font-medium mb-2">üìÅ Upload lydfil (valgfrit)</label>
      <input 
        type="file" 
        id="fileInput" 
        accept="audio/*"
        class="block w-full text-sm text-gray-500
               file:mr-4 file:py-2 file:px-4 file:rounded
               file:border-0 file:text-sm file:font-semibold
               file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
    </div>

    <!-- Slider -->
    <div>
      <label class="block text-sm font-medium mb-2">
        ‚è±Ô∏è Hastighed: <span id="speedDisplay">200</span> ms
      </label>
      <input 
        id="intervalMs" 
        type="range" 
        value="200" 
        min="50" 
        max="1000" 
        step="50"
        class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"/>
    </div>

    <!-- Tone info -->
    <div>
      <h2 class="text-xl font-semibold mb-4">Registreret tone</h2>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <p class="text-sm text-gray-600">Tone:</p>
          <p class="text-3xl font-bold text-blue-600" id="detectedNote">‚Äî</p>
        </div>
        <div>
          <p class="text-sm text-gray-600">Frekvens:</p>
          <p class="text-3xl font-bold text-purple-600">
            <span id="detectedFreq">‚Äî</span> Hz
          </p>
        </div>
      </div>
    </div>

  </div>

  <!-- "Papiret" hvor SVG ikoner vises -->
  <div class="bg-white rounded-lg shadow-md p-6 mt-8">
    <h2 class="text-xl font-semibold mb-4">Dit musikstykke</h2>
    <div 
      id="paper" 
      class="bg-gray-50 p-4 rounded min-h-[200px] w-full overflow-x-auto flex gap-2"
    >
      <!-- SVG'er tilf√∏jes her -->
    </div>
  </div>

  <!-- JavaScript kode - k√∏rer kun i browseren -->
  <script type="module">
    // ==========================================
    // 1. FIND HTML ELEMENTER
    const startMicBtn = document.getElementById("startMic");
    const stopMicBtn = document.getElementById("stopMic");
    const fileInput = document.getElementById("fileInput");
    const paper = document.getElementById("paper");
    const detectedNoteEl = document.getElementById("detectedNote");
    const detectedFreqEl = document.getElementById("detectedFreq");
    const intervalInput = document.getElementById("intervalMs");
    const speedDisplay = document.getElementById("speedDisplay");

    // ==========================================
    // 2. VARIABLER TIL LYDDETEKTION
    let audioContext;
    let mediaStreamSource;
    let scriptProcessor;
    let micStream;

    // ==========================================
    // 3. MAPPING FRA TONE TIL SVG FILER
    const noteSvgMap = {
      "C": "/doodles/C.svg",
      "C#": "/doodles/C#.svg",
      "D": "/doodles/D.svg",
      "D#": "/doodles/D#.svg",
      "E": "/doodles/E.svg",
      "F": "/doodles/F.svg",
      "F#": "/doodles/F#.svg",
      "G": "/doodles/G.svg",
      "G#": "/doodles/G#.svg",
      "A": "/doodles/A.svg",
      "A#": "/doodles/A#.svg",
      "B": "/doodles/B.svg"
    };

    // ==========================================
    // 4. OPDATER HASTIGHED DISPLAY
    intervalInput.addEventListener("input", e => {
      speedDisplay.textContent = e.target.value;
    });

    // ==========================================
    // 5. KONVERTER FREKVENS TIL TONE-NAVN
    function freqToNoteName(frequency) {
      if (!frequency || frequency <= 0) return null;
      const midi = Math.round(12 * (Math.log2(frequency / 440)) + 69);
      const names = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
      const noteIndex = midi % 12;
      const noteName = names[noteIndex];
      console.log(`Frekvens: ${frequency.toFixed(1)} Hz ‚Üí MIDI: ${midi} ‚Üí Note: ${noteName}`);
      return { name: noteName, midi };
    }

    // ==========================================
    // 6. AUTO-CORRELATION (Pitch Detection)
    function autoCorrelate(buffer, sampleRate) {
      const SIZE = buffer.length;
      let rms = 0;
      for (let i = 0; i < SIZE; i++) rms += buffer[i] * buffer[i];
      rms = Math.sqrt(rms / SIZE);
      if (rms < 0.01) return -1;

      let bestOffset = -1, bestCorrelation = 0, lastCorrelation = 1;
      const minOffset = Math.floor(sampleRate / 1000);
      const maxOffset = Math.floor(sampleRate / 50);

      for (let offset = minOffset; offset < maxOffset; offset++) {
        let correlation = 0;
        for (let i = 0; i < SIZE - offset; i++)
          correlation += Math.abs(buffer[i] - buffer[i + offset]);
        correlation = 1 - (correlation / SIZE);
        if (correlation > 0.9 && correlation > lastCorrelation) {
          if (correlation > bestCorrelation) { bestCorrelation = correlation; bestOffset = offset; }
        }
        lastCorrelation = correlation;
      }
      if (bestOffset !== -1 && bestCorrelation > 0.9) return sampleRate / bestOffset;
      return -1;
    }

    // ==========================================
    // 7. HENT SVG FRA DINE FILER
    async function getSvgForNote(name) {
      const path = noteSvgMap[name];
      if (!path) return null;
      try {
        const res = await fetch(path);
        if (!res.ok) return null;
        return await res.text();
      } catch (e) {
        console.log("Fejl ved hentning af SVG:", e);
        return null;
      }
    }

    // ==========================================
    // 8. VIS EN TONE P√Ö "PAPIRET"
    async function renderNoteOnPaper(name) {
      let svgHtml = await getSvgForNote(name);
      const wrapper = document.createElement("div");
      if (!svgHtml) {
        // Fallback hvis SVG mangler
        wrapper.innerHTML = `<svg viewBox="0 0 50 50" class="w-12 h-12"><rect x="5" y="5" width="40" height="40" rx="8" fill="#1E1E1E"/><text x="25" y="32" font-size="14" font-weight="bold" text-anchor="middle" fill="white">${name}</text></svg>`;
      } else {
        wrapper.innerHTML = svgHtml;
      }
      const svgEl = wrapper.firstElementChild;
      if (!svgEl) return;

      svgEl.removeAttribute("width");
      svgEl.removeAttribute("height");
      svgEl.classList.add("w-12", "h-12", "flex-shrink-0");
      svgEl.style.animation = "slideIn 0.3s ease-out";
      paper.appendChild(svgEl);
      paper.scrollLeft = paper.scrollWidth;
    }

    // ==========================================
    // 9. OPDATER INFO-BOKSEN
    function updateDetected(name, freq) {
      detectedNoteEl.textContent = name;
      detectedFreqEl.textContent = freq.toFixed(1);
    }

    // ==========================================
    // 10. START MIKROFON
    async function startMic() {
      try {
        micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        audioContext = new AudioContext();
        mediaStreamSource = audioContext.createMediaStreamSource(micStream);
        scriptProcessor = audioContext.createScriptProcessor(2048, 1, 1);
        mediaStreamSource.connect(scriptProcessor);
        scriptProcessor.connect(audioContext.destination);

        let lastNoteTime = 0;
        const minTimeBetweenNotes = 100;

        scriptProcessor.onaudioprocess = async e => {
          const buffer = e.inputBuffer.getChannelData(0);
          const now = Date.now();
          if (now - lastNoteTime < minTimeBetweenNotes) return;

          const freq = autoCorrelate(buffer, audioContext.sampleRate);
          if (freq > 0) {
            const note = freqToNoteName(freq);
            if (note && note.name) {
              await renderNoteOnPaper(note.name);
              updateDetected(note.name, freq);
              lastNoteTime = now;
            }
          }
        };

        startMicBtn.disabled = true;
        stopMicBtn.disabled = false;
      } catch (e) {
        alert("Kunne ikke f√• adgang til mikrofonen. Tillad venligst mikrofon adgang.");
        console.error(e);
      }
    }

    // ==========================================
    // 11. STOP MIKROFON
    function stopMic() {
      if (scriptProcessor) scriptProcessor.disconnect();
      if (mediaStreamSource) mediaStreamSource.disconnect();
      if (micStream) micStream.getTracks().forEach(t => t.stop());
      if (audioContext) audioContext.close();

      startMicBtn.disabled = false;
      stopMicBtn.disabled = true;
    }

    // ==========================================
    // 12. PROCES UPLOADET LYDFIL
    async function processAudioBuffer(audioBuffer) {
      const rate = audioBuffer.sampleRate;
      const data = audioBuffer.getChannelData(0);
      const chunk = 2048;
      const interval = parseInt(intervalInput.value);

      for (let i = 0; i < data.length; i += chunk) {
        const slice = data.slice(i, i + chunk);
        const freq = autoCorrelate(slice, rate);
        if (freq > 0) {
          const note = freqToNoteName(freq);
          if (note) {
            await renderNoteOnPaper(note.name);
            updateDetected(note.name, freq);
            await new Promise(res => setTimeout(res, interval));
          }
        }
      }
    }

    // ==========================================
    // 13. EVENT LISTENERS (knap-klik)
    fileInput.addEventListener("change", async e => {
      const file = e.target.files[0];
      if (!file) return;
      try {
        const arrayBuf = await file.arrayBuffer();
        audioContext = new AudioContext();
        const audioBuf = await audioContext.decodeAudioData(arrayBuf);
        await processAudioBuffer(audioBuf);
      } catch (e) {
        alert("Kunne ikke l√¶se lydfilen. Pr√∏v en anden fil.");
        console.error(e);
      }
    });

    startMicBtn.addEventListener("click", startMic);
    stopMicBtn.addEventListener("click", stopMic);
  </script>
</Layout>